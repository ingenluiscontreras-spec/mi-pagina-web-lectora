async function buscar() {
    const query = document.getElementById('busqueda').value;
    const resultadosDiv = document.getElementById('resultados');
    const estadoDiv = document.getElementById('estado');

    if (!query) {
        estadoDiv.innerHTML = "<span class='error'>Escribe algo para buscar.</span>";
        return;
    }

    estadoDiv.innerHTML = "Buscando...";
    resultadosDiv.innerHTML = "";

    try {
        // CONSTRUCCIÓN SEGURA DE URL (Sin comillas invertidas para evitar errores en GitHub)
        const baseUrl = "https://www.googleapis.com/books/v1/volumes";
        const finalUrl = baseUrl + "?q=" + encodeURIComponent(query) + "&key=" + API_KEY;
        
        console.log("Intentando conectar a:", finalUrl);

        const response = await fetch(finalUrl);
        
        if (!response.ok) {
            // Si devuelve 403, tu API Key tiene restricciones en Google Console
            // Si devuelve 400, la búsqueda está mal formada
            throw new Error("Respuesta del servidor: " + response.status);
        }

        const data = await response.json();

        if (!data.items || data.items.length === 0) {
            estadoDiv.innerHTML = "<span class='error'>No se encontraron libros. Prueba con otro título.</span>";
            return;
        }

        estadoDiv.innerHTML = "<span class='success'>Resultados encontrados:</span>";

        data.items.forEach(libro => {
            const info = libro.volumeInfo;
            // Forzamos HTTPS en las imágenes para evitar bloqueos de GitHub Pages
            const portada = info.imageLinks ? info.imageLinks.thumbnail.replace('http:', 'https:') : 'via.placeholder.com';
            
            const div = document.createElement('div');
            div.className = 'libro';
            div.innerHTML = `
                <img src="${portada}" alt="Portada">
                <div class="info">
                    <h3>${info.title}</h3>
                    <p><strong>Autor:</strong> ${info.authors ? info.authors.join(', ') : 'Desconocido'}</p>
                    <p><a href="${info.infoLink}" target="_blank">Ver en Google Books</a></p>
                </div>
            `;
            resultadosDiv.appendChild(div);
        });

    } catch (error) {
        console.error("Error detallado:", error);
        estadoDiv.innerHTML = "<span class='error'>Error de conexión: " + error.message + "</span>";
    }
}
